<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA con CSV + GitHub + API IA Gratuita</title>
    <style>
        body { font-family: Arial; background:#121212; color:white; margin:0; }
        #login, #chat { max-width:900px; margin:auto; padding:20px; }
        .card { background:#1e1e1e; padding:20px; border-radius:10px; margin-top:20px; }
        input, button, textarea { width:100%; padding:10px; margin-top:10px; border-radius:6px; border:none; }
        button { background:#4caf50; color:white; cursor:pointer; }
        #messages { height:400px; overflow-y:auto; border:1px solid #333; padding:10px; margin-top:10px; }
        .msg-user { text-align:right; margin:10px 0; color:#4caf50; }
        .msg-bot { text-align:left; margin:10px 0; color:#81d4fa; }
    </style>
</head>
<body>

<div id="login" class="card">
    <h2>Login</h2>
    <input id="usuario" placeholder="Usuario">
    <input id="password" type="password" placeholder="Contraseña">
    <button onclick="login()">Entrar</button>
    <p id="loginMsg"></p>
</div>

<div id="chat" class="card" style="display:none;">
    <h2>Chat IA Interactivo</h2>
    <div id="messages"></div>
    <textarea id="userInput" placeholder="Escribe tu pregunta..."></textarea>
    <button onclick="sendMessage()">Enviar</button>
</div>

<script>
//-----------------------------------------------------------
// CONFIGURACIÓN
//-----------------------------------------------------------
const URL_CSV = "https://raw.githubusercontent.com/FJCRNX/CHATIABETA/refs/heads/main/conocimiento.csv";
const URL_USUARIOS = "https://raw.githubusercontent.com/FJCRNX/CHATIABETA/refs/heads/main/usuarios.json";

// API gratuita: OpenRouter (requiere API key pero 100% gratis para modelos open-source)
// Puedes crear API key gratis aquí: https://openrouter.ai/
// o usar otro endpoint gratuito si me dices cuál prefieres
const FREE_AI_URL = "https://openrouter.ai/api/v1/chat/completions";
const FREE_AI_KEY = "PON_AQUI_TU_API_KEY_GRATIS";

//-----------------------------------------------------------
let db = [];
let usuariosDB = [];
let chatHistory = [];

//-----------------------------------------------------------
// LOGIN
//-----------------------------------------------------------
async function login() {
    const u = document.getElementById("usuario").value.trim();
    const p = document.getElementById("password").value.trim();
    const msg = document.getElementById("loginMsg");

    if (!usuariosDB.length) await cargarUsuarios();

    const user = usuariosDB.find(x => x.usuario === u && x.password === p);

    if (!user) {
        msg.textContent = "Usuario o contraseña incorrectos";
        msg.style.color = "red";
        return;
    }

    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
}

async function cargarUsuarios() {
    try {
        const res = await fetch(URL_USUARIOS);
        usuariosDB = await res.json();
    } catch (e) {
        console.error("Error cargando usuarios:", e);
    }
}

//-----------------------------------------------------------
// CARGAR CSV DESDE GITHUB
//-----------------------------------------------------------
async function cargarCSV() {
    const res = await fetch(URL_CSV);
    const txt = await res.text();
    const lineas = txt.split(/\r?\n/);
    const encabezados = lineas[0].split(',');

    db = lineas.slice(1).map(l => {
        const cols = l.split(',');
        return {
            tema: cols[0]?.trim() || "",
            tags: cols[1]?.trim() || "",
            descripcion: cols[2]?.trim() || "",
            pasos: cols[3]?.trim() || "",
            areas_responsables: cols[4]?.trim() || ""
        };
    });
}

cargarCSV();

//-----------------------------------------------------------
// CHAT
//-----------------------------------------------------------
function renderMessage(text, cls) {
    const box = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = cls;
    div.textContent = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

async function sendMessage() {
    const pregunta = document.getElementById("userInput").value.trim();
    if (!pregunta) return;

    renderMessage(pregunta, "msg-user");
    document.getElementById("userInput").value = "";

    const respuesta = await procesarPregunta(pregunta);

    renderMessage(respuesta, "msg-bot");
}

//-----------------------------------------------------------
// LÓGICA PRINCIPAL: buscar en CSV → si no está → API gratuita
//-----------------------------------------------------------
async function procesarPregunta(q) {
    const qLower = q.toLowerCase();

    // 1. Buscar coincidencia en CSV
    const item = db.find(x =>
        x.tema.toLowerCase().includes(qLower) ||
        x.tags.toLowerCase().includes(qLower) ||
        x.descripcion.toLowerCase().includes(qLower)
    );

    if (item) {
        return `**${item.tema}**\n${item.descripcion}\n\n**Pasos:**\n${item.pasos}\n\n**Áreas responsables:** ${item.areas_responsables}`;
    }

    // 2. No se encontró en CSV → llamar API IA gratuita
    return await llamarIAFree(q);
}

//-----------------------------------------------------------
// LLAMADA A UNA API GRATUITA DE IA
//-----------------------------------------------------------
async function llamarIAFree(texto) {
    try {
        const body = {
            model: "qwen/qwen2.5-7b-instruct:free", // modelo gratuito
            messages: [
                { role: "system", content: "Responde de forma funcional, clara y fácil de aplicar, sin tecnicismos." },
                { role: "user", content: texto }
            ]
        };

        const res = await fetch(FREE_AI_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${FREE_AI_KEY}`
            },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        return data.choices?.[0]?.message?.content || "No pude generar respuesta.";

    } catch (e) {
        console.error(e);
        return "Error conectando con la IA gratuita.";
    }
}

</script>
</body>
</html>
