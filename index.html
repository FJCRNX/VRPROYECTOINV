<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>VR INVENTARIO 3D (Automático)</title>
<style>
  :root{
    --azul:#0b67d0;
    --rojo:#e02424;
    --blanco:#ffffff;
    --ui-opacity:0.85;
  }
  html,body{
    height:100%;
    margin:0;
    background:linear-gradient(180deg,#071028 0%, #072a4a 60%);
    color:var(--blanco);
    font-family:Inter, system-ui, Arial, sans-serif;
    overflow:hidden;
  }
  .app{position:relative;height:100vh;width:100vw;overflow:hidden;perspective:900px;}
  video#cam{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
  canvas#overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}
  .topbar{position:absolute;left:12px;top:12px;z-index:50;display:flex;gap:10px;align-items:center;}
  .brand{background:rgba(11,103,208,var(--ui-opacity));padding:8px 12px;border-radius:10px;font-weight:700;display:flex;gap:8px;align-items:center;}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--rojo);box-shadow:0 0 6px var(--rojo);}
  button#startBtn{background:rgba(0,0,0,0.2);color:var(--blanco);border:2px solid rgba(255,255,255,0.12);
    padding:8px 12px;border-radius:10px;cursor:pointer;backdrop-filter:blur(4px);transition:all 150ms ease;}
  button#startBtn:hover{border-color:rgba(255,255,255,0.3);transform:translateY(-2px);}
  .hint{position:absolute;left:50%;transform:translateX(-50%);bottom:18px;z-index:50;background:rgba(0,0,0,0.35);
    color:var(--blanco);padding:8px 12px;border-radius:999px;font-size:14px;}
  .qr-popup{position:absolute;z-index:200;display:flex;pointer-events:none;transition:opacity 200ms ease,transform 200ms ease;}
  .qr-img-wrap{position:relative;width:25vw;max-width:280px;min-width:150px;aspect-ratio:1/1;display:block;
    transform-origin:center;animation:float 4s ease-in-out infinite;will-change:transform;z-index:210;}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}
  .qr-img-wrap img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 14px 25px rgba(2,6,23,0.55));transition:filter 0.2s;}
  .close-x{position:absolute;right:-12px;top:-12px;width:34px;height:34px;border-radius:50%;background:var(--rojo);
    display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,0.4);
    cursor:pointer;z-index:220;pointer-events:auto;}
  .popup-timer{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);width:80%;height:4px;
    background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden;}
  .popup-timer-fill{height:100%;background:var(--azul);width:100%;transition:width 10s linear;}
  .pulse{animation:pulse 1.6s infinite;}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,0.06);}70%{box-shadow:0 0 0 14px rgba(11,103,208,0.02);}
    100%{box-shadow:0 0 0 0 rgba(255,255,255,0);}}
  .popup-enter{opacity:0;transform:scale(0.8);}
  .popup-exit{opacity:0;transform:scale(0.8);}
  @media (max-width:600px){.qr-img-wrap{width:36vw;max-width:200px;}}
</style>
</head>
<body>
<div class="app" id="app">
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>
  <div class="topbar">
    <div class="brand"><div class="dot"></div><div>VR INVENTARIO</div></div>
    <button id="startBtn" class="pulse">Iniciar Cámara</button>
  </div>
  <div class="hint" id="hint">Apunta la cámara a un QR para ver el producto.</div>
  <div id="popups" style="position:absolute;inset:0;pointer-events:none;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
const GITHUB_RAW_CSV_URL="https://raw.githubusercontent.com/FJCRNX/QRactivosK/refs/heads/main/base.csv";
const video=document.getElementById('cam'),overlay=document.getElementById('overlay'),
octx=overlay.getContext('2d'),popupsContainer=document.getElementById('popups'),
hint=document.getElementById('hint'),startBtn=document.getElementById('startBtn'),
internalCanvas=document.createElement('canvas');
let qrMap=new Map(),activePopups=new Map();
let running=false,lastDetectionTime=0;
const MAX_POPUPS=10,POPUP_DURATION=10000,DETECTION_INTERVAL=200;

// Datos de orientación y profundidad
let gyro={alpha:0,beta:0,gamma:0},gps={lat:0,lon:0};
let depthZ=0,rotX=0,rotY=0;

// Cargar CSV
async function loadCSVMap(){
  let csvText='';const fallback="qr,imageUrl\nQR-24,https://png.pngtree.com/png-vector/20241225/ourlarge/pngtree-football-without-background-png-image_14845468.png";
  try{
    const r=await fetch(GITHUB_RAW_CSV_URL);if(!r.ok)throw new Error();
    csvText=await r.text();hint.textContent="Base de datos cargada.";
  }catch{csvText=fallback;hint.textContent="Usando datos de ejemplo.";}
  csvText.trim().split(/\r?\n/).slice(1).forEach(l=>{
    const [qr,img]=l.split(',').map(c=>c.trim());
    if(qr&&img)qrMap.set(qr,img);
  });
}

// Iniciar cámara
async function startCamera(){
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:false});
    video.srcObject=s;
    video.onloadedmetadata=()=>{
      video.play();fitCanvas();running=true;
      requestAnimationFrame(detectionLoop);
      startBtn.textContent="Cámara Activa";startBtn.classList.remove('pulse');
      hint.textContent="Escaneando QR...";
    };
    window.addEventListener('resize',fitCanvas);
  }catch(e){alert("Error cámara: "+e.message);}
}
function fitCanvas(){
  overlay.width=overlay.clientWidth;overlay.height=overlay.clientHeight;
  if(video.videoWidth)internalCanvas.width=video.videoWidth,internalCanvas.height=video.videoHeight;
}

// Detección QR
function detectionLoop(){
  if(!running||video.readyState<video.HAVE_ENOUGH_DATA){requestAnimationFrame(detectionLoop);return;}
  if(Date.now()-lastDetectionTime<DETECTION_INTERVAL){requestAnimationFrame(detectionLoop);return;}
  lastDetectionTime=Date.now();
  const ictx=internalCanvas.getContext('2d',{willReadFrequently:true});
  ictx.drawImage(video,0,0,internalCanvas.width,internalCanvas.height);
  const img=ictx.getImageData(0,0,internalCanvas.width,internalCanvas.height);
  const code=jsQR(img.data,img.width,img.height,{inversionAttempts:"dontInvert"});
  const detections=code?[code]:[];
  octx.clearRect(0,0,overlay.width,overlay.height);
  const visible=new Set();
  detections.forEach(d=>{drawPolygon(d.location);visible.add(d.data);});
  for(const [data,p] of activePopups.entries()){
    if(visible.has(data)){
      const det=detections.find(x=>x.data===data);
      updatePopupPosition(data,det.location);
    }
  }
  for(const det of detections){
    if(!activePopups.has(det.data)&&activePopups.size<MAX_POPUPS){
      const url=qrMap.get(det.data);
      if(url)createPopup(det.data,url,det.location);
    }
  }
  requestAnimationFrame(detectionLoop);
}
function drawPolygon(loc){
  const sx=overlay.width/internalCanvas.width,sy=overlay.height/internalCanvas.height;
  octx.lineWidth=4;octx.strokeStyle='rgba(224,36,36,0.95)';
  octx.beginPath();
  octx.moveTo(loc.topLeftCorner.x*sx,loc.topLeftCorner.y*sy);
  octx.lineTo(loc.topRightCorner.x*sx,loc.topRightCorner.y*sy);
  octx.lineTo(loc.bottomRightCorner.x*sx,loc.bottomRightCorner.y*sy);
  octx.lineTo(loc.bottomLeftCorner.x*sx,loc.bottomLeftCorner.y*sy);
  octx.closePath();octx.stroke();
}

// Crear popup
function createPopup(qr,imgUrl,loc){
  const div=document.createElement('div');
  div.className='qr-popup popup-enter';
  const wrap=document.createElement('div');
  wrap.className='qr-img-wrap';
  const img=document.createElement('img');
  img.src=imgUrl;img.alt=qr;
  img.onerror=()=>{img.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='200' height='200' fill='%230b67d0'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white'>No disponible</text></svg>";};
  const close=document.createElement('div');
  close.className='close-x';close.textContent='✕';
  close.onclick=e=>{e.stopPropagation();removePopup(qr);}
  const timer=document.createElement('div');
  timer.className='popup-timer';
  const fill=document.createElement('div');
  fill.className='popup-timer-fill';
  timer.appendChild(fill);
  wrap.appendChild(img);wrap.appendChild(close);wrap.appendChild(timer);
  div.appendChild(wrap);popupsContainer.appendChild(div);
  setTimeout(()=>fill.style.width='0%',10);
  const timeoutId=setTimeout(()=>removePopup(qr),POPUP_DURATION);
  activePopups.set(qr,{element:div,location:loc,timeoutId,timer:fill});
  updatePopupPosition(qr,loc);
  setTimeout(()=>div.classList.remove('popup-enter'),200);
}

// Actualizar posición con profundidad
function updatePopupPosition(qr,loc){
  const p=activePopups.get(qr);if(!p)return;
  const sx=overlay.width/internalCanvas.width,sy=overlay.height/internalCanvas.height;
  const cx=(loc.topLeftCorner.x+loc.bottomRightCorner.x)/2;
  const cy=(loc.topLeftCorner.y+loc.bottomRightCorner.y)/2;
  const x=cx*sx;
  const y=cy*sy;

  const z=depthZ*200; // control de profundidad
  const scale=1/(1+Math.abs(z)/500);

  const rotation=`rotateX(${rotX*10}deg) rotateY(${rotY*10}deg)`;
  const translation=`translate3d(${rotY*60}px,${rotX*60}px,${z}px)`;
  p.element.style.left=`${x}px`;
  p.element.style.top=`${y}px`;
  p.element.style.transform=`${translation} ${rotation} scale(${scale})`;

  // Brillo y blur según distancia
  const img=p.element.querySelector('img');
  const blur=Math.min(Math.abs(z)/80,8);
  const brightness=1.2-Math.min(Math.abs(z)/800,0.4);
  img.style.filter=`blur(${blur}px) brightness(${brightness}) drop-shadow(0 14px 25px rgba(2,6,23,0.55))`;
}

function removePopup(qr){
  const p=activePopups.get(qr);if(!p)return;
  clearTimeout(p.timeoutId);
  p.element.classList.add('popup-exit');
  setTimeout(()=>{p.element.remove();activePopups.delete(qr);},200);
}

// Movimiento 3D con giroscopio o GPS
function setupSensors(){
  if(window.DeviceOrientationEvent){
    window.addEventListener('deviceorientation',e=>{
      rotY=(e.gamma||0)/45; // izquierda-derecha
      rotX=(e.beta||0)/45;  // arriba-abajo
      depthZ=Math.sin((e.alpha||0)/90); // acercar/alejar
      for(const [qr,p] of activePopups.entries())updatePopupPosition(qr,p.location);
    });
  }
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(pos=>{
      gps.lat=pos.coords.latitude;gps.lon=pos.coords.longitude;
      depthZ=(gps.lat%1-0.5)*4; // profundidad según posición
    });
  }
}

// Iniciar
startBtn.onclick=async()=>{
  if(!running){
    await loadCSVMap();
    await startCamera();
    setupSensors();
  }
};
loadCSVMap();
</script>
</body>
</html>
